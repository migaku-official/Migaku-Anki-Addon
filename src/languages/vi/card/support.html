<script>

(function () {

const word_pos_names = {
    adj: "Adjective",
    adp: "Adposition",
    adv: "Adverb",
    aux: "Auxiliary",
    conj: "Conjunction",
    cconj: "Coordinating Conjunction",
    det: "Determiner",
    intj: "Interjection",
    noun: "Noun",
    num: "Numeral",
    part: "Particle",
    pron: "Pronoun",
    propn: "Proper Noun",
    punct: "Punctuation",
    sconj: "Subordinationnating conjunction",
    sym: "Symbol",
    verb: "Verb",
    x: "Other",
    space: "Space"
};


function parseSyntax(text) {
    let ret = [];

    const syntax_re = new RegExp(/(([a-zA-Z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u024F]+?)\[(.*?)\])/gm);
    let last_idx = 0;
    let match;

    do {
        match = syntax_re.exec(text);

        if (match) {
            if (match.index > last_idx) {
                ret.push({
                    type: 'plain',
                    text: text.substring(last_idx, match.index)
                });
            }
            
            const args =  match[3].split(',');
            const dict_form = args[0] || '';
            const word_pos = args[1] || '';
            const ipa = (args[2] || '').split(';');
            if (ipa.length == 1 && ipa[0] == '') {
                ipa.pop();
            }

            ret.push({
                type: 'syntax',
                text: match[2],
                dict_form: dict_form,
                word_pos: word_pos,
                ipa: ipa
            });

            last_idx = match.index + match[0].length;
        }
    } while (match);

    if (last_idx < text.length) {
        ret.push({
            type: 'plain',
            text: text.substr(last_idx)
        });
    }

    return ret;
}

function syntaxElementToNode(syntax_element, field_settings) {
    if (syntax_element.type !== 'syntax') {
        return document.createTextNode(syntax_element.text);
    }
    else {
        const word_container = document.createElement('span');
        word_container.classList.add('word');

        const audio_play_word = syntax_element.text;
        word_container.addEventListener('click', function() {
            pycmd('play_audio-' + audio_play_word);
        });

        const text_elem = document.createElement('span');
        text_elem.textContent = syntax_element.text;
        text_elem.classList.add('word-text');

        word_container.appendChild(text_elem);

        if (field_settings.popup === 'yes') {
            const popup_hover_box = document.createElement('div');
            popup_hover_box.classList.add('popup-hover-box');
            word_container.appendChild(popup_hover_box);

            const popup_container = document.createElement('div');
            popup_container.classList.add('popup');
            word_container.appendChild(popup_container);
            
            const pos_gender = document.createElement('div');
            pos_gender.classList.add('word-pos-gender');
            popup_container.appendChild(pos_gender);

            const pos = document.createElement('div');
            pos.classList.add('word-pos');
            pos.textContent = word_pos_names[syntax_element.word_pos] || '';
            pos_gender.appendChild(pos);

            const gender_symbol = document.createElement('div');
            pos_gender.appendChild(gender_symbol);
            
            const ipa_text = syntax_element.ipa.join(' ');
            if (ipa_text.length > 0) {
                const ipa_container = document.createElement('div');
                ipa_container.classList.add('ipa');
                ipa_container.textContent = ipa_text;
                popup_container.appendChild(ipa_container);
            }

            const dict_form = document.createElement('div');
            dict_form.classList.add('dict-form');
            dict_form.textContent = syntax_element.dict_form;
            popup_container.appendChild(dict_form);
        }

        return word_container;
    }
}

function syntaxToNodes(syntax, field_settings) {
    return syntax.map(function (syntax_element) {
        return syntaxElementToNode(syntax_element, field_settings);
    });
}


function handleFieldTextNodes(node, field_settings) {
    if (node.nodeType == Node.TEXT_NODE) {
        const text = node.textContent;
        const syntax = parseSyntax(text);
        const nodes = syntaxToNodes(syntax, field_settings);
        for (const child of nodes) {
            node.parentNode.insertBefore(child, node);
        }
        node.parentNode.removeChild(node);
    }
    else {
        for (let i = node.childNodes.length - 1; i >= 0; i--) {
            handleFieldTextNodes(node.childNodes[i], field_settings);
        }
    }
}

function handleField(field) {
    const field_settings = {
        popup: field.getAttribute('data-popup') || 'no'
    };

    handleFieldTextNodes(field, field_settings);
}


const fields = document.querySelectorAll('.field');

for (field of fields) {
    handleField(field);
}


function closeAllActive() {
    const current_popups = document.querySelectorAll('.active');
    for (const popup of current_popups) {
        popup.classList.remove('active', 'popup-active');
    }
}

function on_closeAllActiveBody(event) {
    if (!event.target.closest('.word')) {
        closeAllActive();
    }
}

function activeEnablePopup(elem) {
    const popup_elem = elem.querySelector('.popup');
    if (!popup_elem) {
        return
    }

    elem.classList.add('popup-active');

    function isTooHigh() {
        return popup_elem.getBoundingClientRect().top < 0
    }
    
    function isTooLow() {
        return popup_elem.getBoundingClientRect().bottom >= (window.innerHeight || document.documentElement.clientHeight)
    }
    
    function isTooRight() {
        return popup_elem.getBoundingClientRect().right >= (window.innerWidth || document.documentElement.clientWidth)
    }
    
    function isTooLeft() {
        return popup_elem.getBoundingClientRect().left < 0
    }

    elem.classList.remove('popup-direction-u', 'popup-direction-d', 'popup-direction-l', 'popup-direction-r');

    elem.classList.add('popup-direction-u');
    if (!isTooHigh()) {
        return;
    }
    elem.classList.remove('popup-direction-u');

    elem.classList.add('popup-direction-d');
    if (!isTooLow()) {
        return;
    }
    elem.classList.remove('popup-direction-d');

    elem.classList.add('popup-direction-l');
    if (!isTooLeft()) {
        return;
    }
    elem.classList.remove('popup-direction-l');

    elem.classList.add('popup-direction-r');
    if (!isTooRight()) {
        return;
    }
    elem.classList.remove('popup-direction-r');

    elem.classList.add('popup-direction-u');
}

function on_activeEnter() {
    closeAllActive();
    this.classList.add('active');
    activeEnablePopup(this);
}

function on_activeLeave() {
    this.classList.remove('active', 'popup-active');
}

const word_elements = document.querySelectorAll('.word');
const is_mobile = typeof(pycmd) === typeof(undefined);

for (elem of word_elements) {
    elem.addEventListener('mouseenter', on_activeEnter);
    elem.addEventListener('ontouchend', on_activeEnter);
    if (!is_mobile) {
        elem.addEventListener('mouseleave', on_activeLeave);
    }
    if (is_mobile) {
        elem.addEventListener('click', on_activeEnter);
        elem.classList.add('tappable');
    }
}

if (is_mobile) {
    document.body.addEventListener('click', on_closeAllActiveBody);       
    document.body.classList.add('tappable'); 
}

}());

</script>